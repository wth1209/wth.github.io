<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>2048游戏</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(4, 80px);
            grid-gap: 10px;
            background-color: #ad9d8f;
            padding: 10px;
            border-radius: 10px;
        }
        .grid-item {
            width: 80px;
            height: 80px;
            background-color: #cdc1b4;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #776e65;
            font-size: 20px;
            font-weight: bold;
            border-radius: 5px;
        }
        .buttons {
            margin-top: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div>
        <div class="grid-container" id="grid-container"></div>
        <div class="buttons">
            <button onclick="undo()">撤销</button>
            <button onclick="resetGame()">重置</button>
        </div>
    </div>

    <script>
        const gridSize = 4;
        let grid = [];
        let stack = [];

        function initGrid() {
            grid = Array(gridSize).fill().map(() => Array(gridSize).fill(0));
            placeRandom();
            placeRandom();
            updateUI();
        }

        function placeRandom() {
            let empty = [];
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (grid[r][c] === 0) empty.push({ r, c });
                }
            }
            if (empty.length > 0) {
                let { r, c } = empty[Math.floor(Math.random() * empty.length)];
                grid[r][c] = Math.random() > 0.9 ? 4 : 2;
            }
        }

        function updateUI() {
            const container = document.getElementById("grid-container");
            container.innerHTML = '';
            grid.forEach(row => {
                row.forEach(value => {
                    const cell = document.createElement("div");
                    cell.className = "grid-item";
                    cell.textContent = value !== 0 ? value : '';
                    container.appendChild(cell);
                });
            });
            if (isGameOver()) {
                alert("游戏结束");
                // 这里可以添加其他游戏结束逻辑
            }
        }

function move(direction) {
            let oldGrid = JSON.parse(JSON.stringify(grid));
            if (direction === 'ArrowUp' || direction === 'ArrowDown') {
                for (let c = 0; c < gridSize; c++) {
                    let column = [];
                    for (let r = 0; r < gridSize; r++) {
                        column.push(grid[r][c]);
                    }
                    if (direction === 'ArrowDown') column.reverse();
                    let merged = merge(column);
                    if (direction === 'ArrowDown') merged.reverse();
                    for (let r = 0; r < gridSize; r++) {
                        grid[r][c] = merged[r];
                    }
                }
            } else {
                for (let r = 0; r < gridSize; r++) {
                    let row = grid[r].slice();
                    if (direction === 'ArrowRight') row.reverse();
                    let merged = merge(row);
                    if (direction === 'ArrowRight') merged.reverse();
                    grid[r] = merged;
                }
            }
            if (JSON.stringify(oldGrid) !== JSON.stringify(grid)) {
                stack.push(oldGrid);
                placeRandom();
                updateUI();
                checkWin();
            }
        }

        function merge(line) {
            let merged = [];
            for (let i = 0; i < line.length; i++) {
                if (line[i] !== 0) {
                    if (i < line.length - 1 && line[i] === line[i + 1]) {
                        merged.push(line[i] * 2);
                        i++; // Skip the next element as it is already merged
                    } else {
                        merged.push(line[i]);
                    }
                }
            }
            while (merged.length < gridSize) {
                merged.push(0); // Fill the remaining spaces with 0s to maintain the array size
            }
            return merged;
        }

        function isGameOver() {
            for (let r = 0; r < gridSize; r++) {
                for (let c = 0; c < gridSize; c++) {
                    if (grid[r][c] === 0) return false;
                    if (c < gridSize - 1 && grid[r][c] === grid[r][c + 1]) return false;
                    if (r < gridSize - 1 && grid[r][c] === grid[r + 1][c]) return false;
                }
            }
            return true; // 没有空格子也没有可以合并的格子，游戏结束
        }

        function checkWin() {
            if (grid.some(row => row.includes(2048))) {
                setTimeout(() => alert("游戏胜利!"), 50); // 延迟弹窗以确保UI更新
            }
        }

        function undo() {
            if (stack.length > 0) {
                grid = stack.pop();
                updateUI();
            }
        }

        function resetGame() {
            stack = [];
            initGrid();
        }

        document.addEventListener('keydown', (event) => {
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(event.key)) {
                move(event.key);
                event.preventDefault();
            }
        });

        window.onload = initGrid;
    </script>
</body>
</html>
